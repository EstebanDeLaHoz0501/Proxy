class_name Phishing
extends MalwareBase

# El constructor _init() es donde definimos las caracter칤sticas
func _init(nodo_inicio: NodoRed = null):
	# Llama al constructor del padre (MalwareBase)
	super._init("Phishing", nodo_inicio) 
	
	# Sobrescribimos propiedades (Velocidad m치s lenta para ser m치s enga침oso)
	velocidad_infeccion = 1 # Un 20% m치s lento que el base (1.0)

	# L칩gica de Spawn del Phishing
	if nodo_inicio == null:
		# Si se llama sin un nodo, encontramos su spawn point
		var target_node = MAPMANAGER.todos_los_nodos["Servidor_Mensajeria"]
		
		if target_node:
			mover_a_nodo(target_node)
		else:
			# Error cr칤tico si no se encuentra el spawn point
			print("ERROR: No se encontr칩 el Servidor de Mensajer칤a para spawnear Phishing.")
			
func procesar_ia(delta: float):
	if nodo_actual == null: return
	# 1. Si el nodo YA es nuestro (Nivel 3), intentamos movernos
	if nodo_actual.es_nucleo:
		conquistar_nodo(delta)
	elif nodo_actual.nivel_infeccion >= 3:
		nodoMasCercano(nodoObjetivo)
	else:
		# 2. Si no es nuestro, lo conquistamos
		conquistar_nodo(delta)
	acumulador += delta  # Delta es el tiempo entre frames
	if acumulador >= 1.0:
		acumulador = 0.0
		print(self.nombre,' ',self.nodo_actual.id_numero,' ', self.progreso_conquista, ' ',self.nodo_actual.nivel_infeccion )

	
func intentar_expandir():
	# Buscamos un vecino que NO est칠 tomado a칰n
	for nodo in nodo_actual.vecinos:
		print(nodo.id_numero)
	if(nodoMasCercano(7).malware_presente != null):
		mover_a_nodo(nodoMasCercano(7))
	else:
		for vecino in nodo_actual.vecinos:
			if vecino.nivel_infeccion < 3 and vecino.malware_presente == null :
				mover_a_nodo(vecino)
				return # Nos movimos, terminamos por hoy
				
func conquistar_nodo(delta: float):
	# Usamos la nueva constante de 8 segundos y la velocidad (que ahora existe)
	progreso_conquista += velocidad_infeccion * delta
	
	# 游뚿 Comprobaci칩n de conquista (8 segundos)
	if progreso_conquista >= UMBRAL_CONQUISTA_POR_NIVEL: 
		progreso_conquista -= UMBRAL_CONQUISTA_POR_NIVEL # Restamos los 8 segundos para empezar la cuenta del siguiente nivel
		
		# 2. L칩gica de 4 niveles (0, 1, 2, 3)
		if nodo_actual.es_nucleo:
			print('nada')
			if nodo_actual.nivel_infeccion < 4: # El m치ximo nivel es 3 (Tomado)
				nodo_actual.nivel_infeccion += 1
				print("Nivel de infecci칩n de " + str(nodo_actual.id_numero) + " subi칩 a: " + str(nodo_actual.nivel_infeccion))
				if nodo_actual.nivel_infeccion == 4:
					print("춰NODO TOMADO!: " + str(nodo_actual.id_numero))
					var gm = GAMEMANAGER
					if gm:
						gm.trigger_game_over('Phishing')
						return # Detenemos el malware
		else:
			if nodo_actual.nivel_infeccion < 3: # El m치ximo nivel es 3 (Tomado)
				nodo_actual.nivel_infeccion += 1
				print("Nivel de infecci칩n de " + str(nodo_actual.id_numero) + " subi칩 a: " + str(nodo_actual.nivel_infeccion))
				
				if nodo_actual.nivel_infeccion == 3:
					print("춰NODO TOMADO!: " + str(nodo_actual.id_numero))
					
