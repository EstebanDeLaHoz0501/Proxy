class_name MalwareBase
extends RefCounted # No es un nodo visual, es l贸gica pura

var nombre: String
var nodo_actual: NodoRed = null
var velocidad_infeccion: float = 1.0 # Qu茅 tan r谩pido toma el nodo
var nodoObjetivo = 7
var nodo_origen
func _init(nombre_malware: String, nodo_inicio: NodoRed):
	nombre = nombre_malware
	nodo_origen = nodo_inicio
	mover_a_nodo(nodo_inicio)

# Esta funci贸n la llama el GameManager cada segundo (o cada frame)
var acumulador: float
func procesar_ia(delta: float):
	if nodo_actual == null: return
	# 1. Si el nodo YA es nuestro (Nivel 3), intentamos movernos
	if nodo_actual.nivel_infeccion >= 3:
		nodoMasCercano(nodoObjetivo)
	else:
		# 2. Si no es nuestro, lo conquistamos
		conquistar_nodo(delta)
	acumulador += delta  # Delta es el tiempo entre frames
	if acumulador >= 1.0:
		acumulador = 0.0
		print(self.nombre,' ',self.nodo_actual.id_numero,' ', self.progreso_conquista, ' ',self.nodo_actual.nivel_infeccion )

func intentar_expandir():
	# Buscamos un vecino que NO est茅 tomado a煤n

	for vecino in nodo_actual.vecinos:
		if vecino.nivel_infeccion < 3 and vecino.malware_presente == null:
			mover_a_nodo(vecino)
			return # Nos movimos, terminamos por hoy

func mover_a_nodo(nuevo_nodo: NodoRed):
	# Salimos del anterior
	if nodo_actual != null:
		nodo_actual.malware_presente = null
	
	# Entramos al nuevo
	nodo_actual = nuevo_nodo
	nodo_actual.malware_presente = self
	nodo_actual.nivel_infeccion = 1 # 隆Infectado!
	#print(nombre + " se movi贸 a " + str(nodo_actual.id))
	
var progreso_conquista: float = 0.0


# 憋 NUEVO UMBRAL: 8 segundos para subir un nivel de infecci贸n
const UMBRAL_CONQUISTA_POR_NIVEL: float = 20.0 

# ... (resto de tu constructor _init)
func nodoMasCercano(nodo_objetivo):
	if nodo_actual.id_numero == nodo_objetivo:
		return
	for nodo in nodo_actual.vecinos:
		print(nodo.id_numero)
	var sw = false
	var id = nodo_objetivo
	var menor = {}
	for vecino in nodo_actual.vecinos:
		menor[vecino]=abs(vecino.id_numero-id)
	print(menor)
	while(sw == false):
		var mascercano = menor.values().min()
		var vecinomascercano = null
		for key in menor:
			if menor[key] == mascercano:
				vecinomascercano = key
		if vecinomascercano.malware_presente != null:
			if(vecinomascercano.id_numero == 7):
				mover_a_nodo(vecinomascercano)
				print('en el nucleoooo')
				sw = true
				return
			menor.erase(vecinomascercano)
			if(menor.is_empty()):
				print('atrapado tio')
				sw = true
		else:
			print('derecho al nucleo')
			mover_a_nodo(vecinomascercano)
			sw = true
			
func conquistar_nodo(delta: float):
	# Usamos la nueva constante de 8 segundos y la velocidad (que ahora existe)
	progreso_conquista += velocidad_infeccion * delta
	
	#  Comprobaci贸n de conquista (8 segundos)
	if progreso_conquista >= UMBRAL_CONQUISTA_POR_NIVEL: 
		progreso_conquista -= UMBRAL_CONQUISTA_POR_NIVEL # Restamos los 8 segundos para empezar la cuenta del siguiente nivel
		
		# 2. L贸gica de 4 niveles (0, 1, 2, 3)
		if nodo_actual.nivel_infeccion < 3: # El m谩ximo nivel es 3 (Tomado)
			nodo_actual.nivel_infeccion += 1
			print("Nivel de infecci贸n de " + str(nodo_actual.id_numero) + " subi贸 a: " + str(nodo_actual.nivel_infeccion))
			
			if nodo_actual.nivel_infeccion == 3:
				print("隆NODO TOMADO!: " + str(nodo_actual.id_numero))
				
func volver_a_origen():
	mover_a_nodo(nodo_origen)
